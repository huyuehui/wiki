#+TITLE: Home Network
#+DATE: [2017-12-25 Mon 16:43]
#+KEYWORDS: network
#+SETUPFILE: ../org-templates/level-1.org

* TODO see vlan_create_ in opmode.sh

* Optical Modem
  
** Replace rg200O with sa1456c
Beijing Unicom offers a rg200O optical modem, which has routing feature enabled and 2.4g wifi supported. To fully customize my home network, I replace rg200O with sa1456c([[https://item.taobao.com/item.htm?spm=a1z09.2.0.0.428b4feU4DkdH&id=534130004778&_u=pb29cccb094][Bought from Taobao]]).

*** rg200o 
The biggest adventage of rg200o is that it's a all-in-one optical modem. It has 1GbE(LAN1) and 3FE. The internet routing is enabled by default, which isn't what I wanted and I need to bridge the internet connection. The IPTV feature is configured with DHCP(WAN) and Static Routing(LAN). So each one of the four ports offers internet and IPTV connection, respectively, to your device.

*** kd-yun-811e
After a network failure at [2019-06-28 Fri], Beijing Unicom replaced =rg200o= with =kd-yun-811e=. =sa1456c= should be re-authenticated with the new MAC address. Check =kd-yun-811e= carefully.

**** Login as Admin
According to [[https://guanggai.org/thread-563-1-1.html][TEWA-800EÁ†¥Ëß£Ëé∑ÂèñË∂ÖÁ∫ßÂØÜÁ†Å]]:
#+BEGIN_EXAMPLE
  Chrome, access http://192.168.1.1 which is the login page of kd-yun-811e

  F12
  Elements -> CTRL+F user_name :
  <input name="username" id="user_name" type="text" size="20" value="user">
  Double click "user_name", change to "CUAdmin"

  Sources -> (index) -> CTRL+F function submitFrm() -> Select & Copy the entire funtion

  Console -> Paste the funtion and edit:
  ,****************************
  function submitFrm()
  {
	  with(document.forms[0])
	  {
		  if ( password.value.length == 0 ) {
		     alert('ÂØÜÁ†Å‰∏çÂæó‰∏∫Á©∫!');
		     return;
		  }
		  if(username.value!='CUAdmin') {  <------
		     alert('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÁî®Êà∑Ë¥¶Êà∑!');
		     return;
		  }

	  }
	  document.getElementById('loginfrm').submit();
  }
  ******************************
  Scroll to the end of submitFrm and HIT "Enter‚Ü≤" key!

  Login as CUAdmin, password: CUAdmin
#+END_EXAMPLE

*** sa1456c
It is an all-in-one optical modem with 4GbE ports.
Default Settings:
| Configuration IP | 192.168.100.1 |
| Super User Name  | t**...**      |
| Super User Pass  | a**..**       |
| Wireless Name    | Wireless*...* |
| Wireless Pass    | *...*         |

**** Authentication
The seller has pre-configured sa1456c with a *Bridged* internet WAN, a *Routing* IPTV and a *Routing* VOIP. 
A new sa1456c, which has *NOT* been authenticated to Beijing ChinaUnicom, can be authenticated via web GUI:
#+BEGIN_EXAMPLE
  Á≥ªÁªüÂ∑•ÂÖ∑
    -> ONTËÆ§ËØÅ
       -> ËÆ§ËØÅÊñπÂºè :
    ËøôÈáåÈÄâÊã©‰ª•Ëá™ÂÆö‰πâMACÂú∞ÂùÄÂêëÂåó‰∫¨ËÅîÈÄöËøõË°åËÆ§ËØÅ
  
  NOTEÔºö
  
  ÊçÆËØ¥ÔºåÂåó‰∫¨ËÅîÈÄöEPONÊòØMACËÆ§ËØÅ„ÄÇÂ¶ÇÊûúÂÖâÁå´‰ª•ÂâçÊ≤°ÊúâËÆ§ËØÅËøáÔºåÊâç‰ºöÊúâ‰ΩøÁî®MACÂú∞ÂùÄ
  ËÆ§ËØÅÁöÑÈÄâÈ°π„ÄÇÂ¶ÇÊûú‰ª•ÂâçËÆ§ËØÅËøáÔºåËÆ§ËØÅÊñπÂºèÂè™ËÉΩÈÄâÊã©‚ÄúÈÄªËæëÊ†áËØÜËÆ§ËØÅ‚ÄùÂíå‚ÄúÂçé‰∏∫
  KEYËÆ§ËØÅ‚Äù„ÄÇÊàë‰π∞ÁöÑËøôÂè™sa1456cÁî±‰∫éÈÄöÁîµÊó∂ËøûÁùÄÂÖâÁ∫§ÔºåÂøòËÆ∞ÂÖà‰øÆÊîπ‰∏∫rg200OÁöÑ
  MACÂú∞ÂùÄÔºåÂØºËá¥ÂÖâÁå´Ëá™Âä®‰ª•Ëá™Ë∫´MACÂú∞ÂùÄÂêëËÅîÈÄöËÆ§ËØÅÔºåGUIÈáå‰ª•Ëá™ÂÆö‰πâMACËÆ§ËØÅÁöÑÈÄâ
  È°πÊ∂àÂ§±ÔºåÂè™ËÉΩÁî®ÊâãÂä®ÊñπÂºèËÆ§ËØÅÔºåÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö
  
  ÂÆâÂÖ®
    -> ËÆæÂ§áËÆøÈóÆÊéßÂà∂ÈÖçÁΩÆ
       -> LANÊúçÂä°
    -> ‰ΩøËÉΩLAN‰æßPCÈÄöËøáSSHËÆøÈóÆËÆæÂ§á : ‚úî
  
  $ssh root@192.168.100.1‚Ü≤  ‚ù∂
  root@192.168.100.1's password:*...*‚Ü≤
  WAP>su‚Ü≤
  SU_WAP>?  <-- Show available commands
  SU_WAP>set productmac MAC AA:BB:CC:DD‚Ü≤
  
  success!
  SU_WAP>quit‚Ü≤
  WAP>quit‚Ü≤
  $
  
  
  ‚ù∂
  # If you get the following error:
  
  Unable to negotiate with 192.168.100.1 port 22: no matching host key type found. Their offer: ssh-rsa
  
  # Try this:
  ssh -o HostKeyAlgorithms=+ssh-rsa root@192.168.100.1‚Ü≤
  
  # Or you can add these to ~/.ssh/config
  
  Host 192.168.100.1
    User root
    HostkeyAlgorithms +ssh-rsa
#+END_EXAMPLE

**** Configure sa1456c
Fundamental settings:
#+BEGIN_EXAMPLE
  WAN
	  -> WANÈÖçÁΩÆ
	     -> 1_INTERNET_B_VID_3961
		-> WANÁ±ªÂûã : Ê°•Êé•WAN
		-> ‰ΩøËÉΩVLAN : ‚òë
		-> VLAN ID : 3961
		-> 802.1p‰ºòÂÖàÁ∫ß: 0
		-> ÁªëÂÆöÈ°π : ‚òêLAN1 ‚òêLAN2 ‚òêLAN3 ‚òêLAN4
		IPv4‰ø°ÊÅØ
		-> ÁªÑÊí≠VLAN : 4000

	     -> 2_VOIP_R_VID_3010
		-> WANÁ±ªÂûã : Ë∑ØÁî±WAN
		-> VLAN ID : 3010
		-> 802.1p‰ºòÂÖàÁ∫ß : 5
		-> MTU : 1492  <- ‚ë†
		-> ÁªëÂÆöÈ°π Ôºö ‚òêLAN1 ‚òêLAN2 ‚òêLAN3 ‚òêLAN4
		-> IPÂú∞ÂùÄËé∑ÂèñÊñπÂºè : Static
		-> IPÂú∞ÂùÄ : 10.189.90.191
		-> Â≠êÁΩëÊé©Á†Å : 255.255.254.0
		-> ÈªòËÆ§ÁΩëÂÖ≥ : 10.189.90.1

	     -> 3_IPTV_R_VID_3964
		-> WANÁ±ªÂûã : Ë∑ØÁî±WAN
		-> VLAN ID : 3964
		-> 802.1p‰ºòÂÖàÁ∫ß : 4
		-> MTU : 1460
		-> IPÂú∞ÂùÄËé∑ÂèñÊñπÂºè : DHCP
		-> ‰ΩøËÉΩNAT : ‚úî
		-> ÁªÑÊí≠VLAN : 4000

  LAN
	  -> DHCPÊúçÂä°ÈÖçÁΩÆ
	     -> ‰∏ªÂú∞ÂùÄÊ±†
		-> ÁªìÊùüIPÂú∞ÂùÄ : 192.168.100.250 <- ‚ë°

  Ë∑ØÁî±
	  -> VLANÁªëÂÆöÈÖçÁΩÆ
	     -> ËßÅ‚ù∏

  ËØ≠Èü≥
	  -> ËØ≠Èü≥Âü∫Êú¨ËÆæÁΩÆ (SIP)
	     -> Êé•Âè£Âü∫Êú¨ÂèÇÊï∞
		-> OutboundÊúçÂä°Âô®Âú∞ÂùÄ : 10.203.255.1
		-> OutboundÊúçÂä°Âô®Á´ØÂè£Âè∑ : 5060
		-> Â§áÁî®OutboundÊúçÂä°Âô®Âú∞ÂùÄ : 10.203.255.17
		-> Â§áÁî®OutboundÊúçÂä°Âô®Á´ØÂè£Âè∑ : 5060
	     -> Áî®Êà∑Âü∫Êú¨ÂèÇÊï∞ (SIP)
		-> URI : +8610********
		-> Èâ¥ÊùÉÁî®Êà∑Âêç : +8610********@bj.ims.chinaunicom.cn
		-> ÂØÜÁ†Å : *...*  ‚ë¢

  ÁΩëÁªúÂ∫îÁî®
	  -> ÁªÑÊí≠ÈÖçÁΩÆ
	     -> ‰ΩøËÉΩÁªÑÊí≠: ‰ΩøËÉΩ
	     -> ÁªÑÊí≠Â∑•‰ΩúÊ®°Âºè: Snooping
	     ...
	     -> PPPoEË∑ØÁî±WAN ProxyÊ®°Âºè: IPoEAndPPPoE
	     ...

  Á≥ªÁªüÂ∑•ÂÖ∑
	  -> Êó∂Èó¥ËÆæÁΩÆ
	     -> Ëá™Âä®ÂêåÊ≠•ÁΩëÁªúÊó∂Èó¥ÊúçÂä°Âô® : ‚òë
	     -> ‰∏ÄÁ∫ßSNTPÊúçÂä°Âô® : 123.124.120.225
	     -> ‰∫åÁ∫ßSNTPÊúçÂä°Âô® : ntp1.tummy.com
	     -> Êó∂Èó¥Âå∫Âüü : GMT+08:00 Beijing, Chongqing, Hong Kong, Urumqi
	     -> Êó∂Èó¥ÂêåÊ≠•Âë®Êúü : 86400
	     -> WANÂêçÁß∞ : 1_INTERNET_R_VID_3961

  NOTE:
  ‚ë† kd-yun-811e's backupsettings.conf uses 1492
  ‚ë° excludes 192.168.100.251 ~ 192.168.100.254 for using in subordinate routers.
  ‚ë¢ found in backupsettings.conf for r200o
#+END_EXAMPLE
‚ù∏ VLANÁªëÂÆöÈÖçÁΩÆÔºö
| Á´ØÂè£ | ÁªëÂÆöÊ®°Âºè | ÁªëÂÆöVLANÂØπ          |
| LAN1 | VLANÁªëÂÆö | 3961/3961,3964/3964 |
Á´ØÂè£: LAN1
Á´ØÂè£Ê®°Âºè: VLANÁªëÂÆö
ÁªëÂÆöVLANÂØπ: 3961/3961,3964/3964
Âá∫Âè£ÁªÑÊí≠VLANÂä®‰Ωú: ‰∏çÂÖ≥Ê≥®

Optimal settings:
#+BEGIN_EXAMPLE
  ## Access Limitation
  ÂÆâÂÖ®
	  -> ËÆæÂ§áËÆøÈóÆÊéßÂà∂ÈÖçÁΩÆ
	     -> LANÊúçÂä°
		-> ‰ΩøËÉΩLAN‰æßPCÈÄöËøáTELNETËÆøÈóÆËÆæÂ§á : ‚òê
	     -> WIFIÊúçÂä°
		-> ‰ΩøËÉΩWIFI‰æßËÆæÂ§áËÆøÈóÆWEBÈ°µÈù¢ : ‚òê
		-> ‰ΩøËÉΩWIFI‰æßPCÈÄöËøáTELNETËÆøÈóÆËÆæÂ§á : ‚òê

  Êó†Á∫øÁΩëÁªú
	  ‚òê ÂºÄÂêØÊó†Á∫øÁΩëÁªú
#+END_EXAMPLE

* Main Router
** netgear r7800
First, connected r7800 as a subordinate router of sa1456c, whose internet wan interface works in routing mode.
Default Settings:
| Configuration IP | 192.168.1.1 |
| Super User Name  | root        |
| Super User Pass  | h*...*      |

The stock firmware is ~1.0.2.28~, which can be automatically upgraded to the newest firmware ~1.0.2.40~ via WEB GUI.

*** Configuration
#+BEGIN_EXAMPLE
  # Basic -> Internet
  Does your Internet connection require a login?
  ‚äôYes

  Internet Service Provider : PPPoE
  Login : 9*...*
  Password : *...*
  Connection Mode : Always On

  # Wireless

  ## Turn off 2.4G Radio
  Advanced -> Advanced Setup -> Wireless Settings
	   -> Advanced Wireless Settings (2.4G b/g/n)
	      ‚òê Enable Wireless Router Radio

  ## Disable SSID Broadcast
  Basic -> Wireless
      	   -> Wireless Network (2.4GHz b/g/n)
      	      ‚òê Enable SSID Broadcast
      	      Name (SSID): S*...*

      	   -> Wireless Network (5GHz 802.11a/n/ac)
	      ‚òê Enable SSID Broadcast
	      Name (SSID): S*...*_5G

  # VLAN settings
  Advanced -> Advanced Setup -> VLAN/Bridge Settings
	   ‚òë Enable VLAN/Bridge group
	     ‚äô By VLAN tag group
	       ‚ù∂

  # BJ Unicom IPTV
  ## Enable DEBUG mode
  http://192.168.1.1/debug.htm
  ‚òë Enable Telnet

  ## Setup IGMProxy TODO:FAIL
  busybox telnet 192.168.1.1‚Ü≤

  root@R7800:/# ip addr add 192.168.100.251/24 dev eth0.3964‚Ü≤
#+END_EXAMPLE
‚ù∂ Port/VLAN mappings:
|    | Enable | Name     | VLAN ID | Priority | Wired Ports                 | Wireless          |
| ‚äô | ‚òë      | Internet |    3961 |        0 | ‚òëPort1 ‚òëPort2 ‚òëPort3 ‚òêPort4 | ‚òëWIFI2.4G ‚òëWIFI5G |
| ‚äô | ‚òë      | IPTV     |    3964 |        0 | ‚òêPort1 ‚òêPort2 ‚òêPort3 ‚òëPort4 | ‚òêWIFI2.4G ‚òêWIFI5G |
See [[Appendix III. R7800 source code]] for details behind the scene.

* Switch: SG 200-08
** Configuration
SG 200-08's facotry default:
|            IP | User name | Password | My Password   |
| 192.168.1.254 | cisco     | cisco    | h*...*6@SG200 |
#+begin_example
  # NOTE
  ÂΩì‰∫§Êç¢Êú∫‰ΩøÁî®Âá∫ÂéÇÈªòËÆ§IPÂú∞ÂùÄÊó∂ÔºåÂÖ∂System LEDÂ∞ÜÊåÅÁª≠Èó™ÁÉÅ„ÄÇÂΩì‰∫§Êç¢Êú∫‰ΩøÁî®DHCPÂàÜÈÖç
  ÁöÑIPÂú∞ÂùÄÊàñÁÆ°ÁêÜÂëòÈÖçÁΩÆÁöÑÈùôÊÄÅIPÂú∞ÂùÄÊó∂ÔºåSystem LEDÂ∞ÜÁ®≥ÂÆö‰∫ÆËµ∑„ÄÇ

  # Configure w/o upsteam R7800
  ## Hobbiton
  ## Verify your ip, if not in the same subnet with SG 200-08:
  ip addr add 192.168.1.247/24 dev eno1‚Ü≤
  ## Then connect to http://192.168.1.254 via your browser.

  # Configure w/ upsteam R7800(DHCP Server)
  ## Hobbiton
  ## Log in to R7800 and check SG 200-08's IP which is allocated via DHCP
  ## Then connect to http://192.168.1.x via your browser

  ## SG 200-08's Web Management UI
  Administration -> Time Settings
		    -> System Time
		       -> Clock Source: ‚¶ø Use SNTP Server
		       -> SNTP Recipient: ‚¶ø Unicast
		       -> Timezone Source - DHCP: ‚òë Enable
		       Apply‚Ü≤
		    -> SNTP Settings
		       Unicast Poll Interval: 7  ‚ù∂
		       Apply‚Ü≤
		    -> Unicast SNTP Servers table
		       Add...‚Ü≤
			 SNTP Server: 192.168.1.1
			 ...
			 Polling Mode: ‚òë Enable
			 ...
			 Apply‚Ü≤

  ‚ù∂ The actual interval, in seconds, is the specified value to the power
  of 2; for example, if you enter 4, the poll interval is 16 seconds.
#+end_example
Whenever you make some changes to the switch, it applies to the
running configuration. To save these changes to the switch, do as
shown below.
#+begin_example
  Adminitration
	  -> File Management
	     -> Copy/Save Configuration  ‚ù∂
		Source File Name:      ‚¶ø Running Configuration  ‚ù∑
		Destination File Name: ‚¶ø Startup Configuration

  ‚ù∂ Or you can click '‚ÆøSave' on the right top of every page.
#+end_example
‚ù∑
+ Running Configuration :: Current configuration, including any
  changes applied in the current management session.
+ Startup Configuration :: Configuration file type used when the
  switch last booted. This does not include any configuration changes
  applied but not yet saved to the switch.
+ Backup Configuration :: Backup configuration file type saved on the switch.
+ Mirror Configuration :: If the Running Configuration is not modified
  for at least 24 hours, it is automatically saved to the Mirror
  Configuration file type.
** Upgrade firmware

#+begin_example
  Administration
    -> File Management
       -> Upgrade/Backup Fireware/Language
       Transfer Method:  ‚¶ø via HTTP
       Save Action:      ‚¶ø Upgrade
       File Type:	       ‚¶ø Firmware Image
       Source File Name: SG200-08x_FW_1.0.8.3.stk  ‚ù∂
       Apply‚Ü≤

    -> Reboot
       Reboot‚Ü≤
#+end_example
‚ù∂ Download from [[https://www.cisco.com/c/en/us/support/switches/sg200-08-8-port-gigabit-smart-switch/model.html#~tab-downloads][here]].
* Application
** Transmission
UPNP or manual port forwarding should be used for Transmission at PC
to upload correctly[fn:6].
#+BEGIN_EXAMPLE
  LEDE
  Network -> Firewall -> Port Forwards
	  -> Name : Transmission
	  -> Protocal : TCP+UDP
	  -> External Zone : wan
	  -> External Port : xxxxx ‚ù∂
	  -> Internel Zone : lan
	  -> Internel IP Address : xxx.xxx.xxx.xxx ('HostName')
	  'Add' and 'Save & Apply'

  NOTES:
  ‚ù∂ In Transmission WEB interface:
    -> 'Edit Preferences...'
       -> Network
     	  -> Listening Port
	     Peer listening port : xxxxx
	     Port is Open <-- If not set correctly, it shows 'Port is Closed'
	  -> ‚òê Randomize port on launch
	  -> ‚òë Use port forwarding from my router
#+END_EXAMPLE

* Appendix I. Special Symbols
~ctrl+x 8‚Ü≤~ "unicode for that symbol"‚Ü≤
| Symbol | Unicode |
| ‚Ü≤      |    21b2 |
| ‚òê      |    2610 |
| ‚òë      |    2611 |
| ‚ë†     |    2460 |
| ‚ù∂      |    2776 |
| ‚¶ø      |    29bf |
| ‚úñ      |    2716 |
| ‚Ä¢      |    2022 |
| ‚ó¶      |    25e6 |
| ‚Üë     |    2191 |
| ‚Üì     |    2193 |
| ‚ØÜ      |    2bc6 |
| ‚áí      |    21d2 |
| ‚Æø      |    2bbf |
| üÖê      |   1f150 |
| ‚åµ      |    2335 |

* Appendix II. Lede
** netgear wndr3700v2
| Configuration IP | 192.168.1.1 |
| Super User Name  | root        |
| Super User Pass  | h*...*      |

For testing [[https://lede-project.org/][LEDE-Project's compatibility]], replace r7800 with 3700v2.

*** Configuration
#+BEGIN_EXAMPLE
  # Wireless

  ## Turn on 5G Radio, hidden SSID
  Network -> Wireless -> Atheros AR9220 802.11an (radio1) -> Edit
	  -> Interface Configuration
	     -> General Setup
		-> ESSID : SHIRE-5G
		-> Hide ESSID : ‚òë
	     -> Wireless Security
		-> Encryption : WPA2-PSK
		-> Key : h*...*

	  -> Device Configuration
	     -> Operating frequency : 40Mhz

	     Enable <- Press the Button here or in "Network -> Wireless"

  System -> Software -> #Update Package List

  # PPPOE
  ## Optimal modem's internet connection is in BRIDGE mode
  Network -> Interfaces -> Interface Overview -> Wan(eth1) -> Edit
	  -> Common Configuration
	     -> Protocal : PPPoE
#+END_EXAMPLE

*** IPTV Testing
**** wndr3700v2 in DHCP mode
Network topology:
#+HEADER: :file ~/work/wiki/public_html/images/network/home_network/wndr3700v2_test.png
#+BEGIN_SRC dot :results silent :exports none
  digraph wndr3700v2 {
	  isp [xlabel="Beijing Unicom", shape=point];
	  r200o [shape=none, margin=0, xlabel="r200o", label=<
	    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="0">
	      <TR>
		<TD ROWSPAN="2">WAN</TD>
		<TD COLSPAN="4">Internet: pppoe</TD>
	      </TR>
	      <TR>
		<TD COLSPAN="4">IPTV: dhcp</TD>
	      </TR>
	      <TR>
		<TD>LAN</TD>
		<TD PORT="lan_r200o_1">1</TD>
		<TD>2</TD>
		<TD>3</TD>
		<TD>4</TD>
	      </TR>
	    </TABLE>>];
	  wndr3700v2 [shape=none, margin=0, xlabel="wndr3700v2", label=<
	    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="0">
	      <TR>
		<TD PORT="wan_3700v2">WAN</TD>
		<TD COLSPAN="4">Internet: dhcp</TD>
	      </TR>
	      <TR>
		<TD>LAN</TD>
		<TD PORT="lan_3700v2_1">1</TD>
		<TD>2</TD>
		<TD>3</TD>
		<TD>4</TD>
	      </TR>
	    </TABLE>>];
	  pc [label="Hobbiton"];

	  isp -> r200o;
	  r200o:lan_r200o_1:c -> wndr3700v2:wan_3700v2:c [headclip=false, tailclip=false];
	  wndr3700v2:lan_3700v2_1:c -> pc [tailclip=false];
  }
#+END_SRC

r200o settings:
#+BEGIN_EXAMPLE
  # Use Internet PPPoE, Port Binding.
  WAN -> WANÈÖçÁΩÆ
      -> 1_INTERNET_R_VID_3961
	 Âü∫Êú¨‰ø°ÊÅØ
		-> Â∞ÅË£ÖÁ±ªÂûã : PPPoE
		-> ÂçèËÆÆÁ±ªÂûã : IPv4
       		-> WANÁ±ªÂûã : Ë∑ØÁî±WAN
       		-> ÊúçÂä°Á±ªÂûã : Internet
       		...
       		-> MRU : 1492
       		...
       		-> ÁªëÂÆöÈ°π : ‚òëLAN1 ‚òêLAN2 ‚òëLAN3 ‚òëLAN4
	 IPv4‰ø°ÊÅØ
		-> IPÂú∞ÂùÄËé∑ÂèñÊñπÂºè : PPPoE
		-> ‰ΩøËÉΩNAT : ‚òë
		-> NATÁ±ªÂûã : Á´ØÂè£ÂèóÈôêÈî•ÂΩ¢NAT
		...
		ÁªÑÊí≠VLAN : 4000  <--IMPORTANT!!
#+END_EXAMPLE
Specify multicast vlan ID will combine multicast traffic together with
normal internet traffic. This is especially useful for watching iptv
live cast stream with Potplayer/VLC. Use port binding will remove vlan
tags (3961 and 4000) inside r200o.

wndr3700v2 settings:
#+BEGIN_EXAMPLE
  # Disable Wireless
  Network -> Wireless -> Wireless Overview
	  -> Atheros AR9220 802.11an (radio1)
	     Click "Disable" (WILL show "Enable")

  # Change configuration IP to be different to r7800
  Network -> Interfaces -> Interface Overview
	  -> LAN (br-lan)
	     -> Edit
		-> Common Configuration
	      	   -> General Setup
		      -> IPv4 Address : 192.168.2.1

  ## Refresh DHCP
  dhcpcd --release   # kill dhcpcd process if needed!
  dhcpcd‚Ü≤
  ip route list‚Ü≤     # verify ROUTE info

  # Install igmpproxy
  System -> Software
       	    -> Actions
	       Download and install package: igmpporxy <- Press "OK"
	    OR
	    -> Status
	       -> Available Packages
	     	  Find igmpproxy in "I" category, install it
#+END_EXAMPLE
According to [[https://wiki.openwrt.org/doc/howto/udp_multicast][OPENWRT::IPTV::HOWTO]], config IGMPProxy as:
#+BEGIN_EXAMPLE
  ssh root@192.168.2.1‚Ü≤  <-  wndr3700v2's ip
  ...

  logread | grep -i igmp‚Ü≤
  --------------------------------------
  ...
  # ...user.warn igmpproxy[21596]: The source address 192.168.1.100 for
  # group 239.2.1.91, is not in any valid net for upstream VIF.
  ...
  # ...user.warn igmpproxy[12318]: The source address 202.106.212.249 for
  # group 239.2.1.131, is not in any valid net for upstream VIF.
  ...
  --------------------------------------

  # Let IGMPProxy to add related firewall rules:
  vi /etc/config/igmpproxy‚Ü≤
  ---------------------------------------
  config igmpproxy
	  option quickleave 1
  #	option verbose [0-2]

  config phyint wan
	  option network wan
	  option direction upstream
	  list altnet 192.168.1.0/24
	  list altnet 202.106.212.0/24

  config phyint lan
	  option network lan
	  option direction downstream
  ---------------------------------------

  /etc/init.d/igmpproxy restart
  # Check IGMP related firewall rules with Luci or:
  iptables -L | grep -i igmp
  # Don't use UCI because IGMPProxy is NOT working with it!
#+END_EXAMPLE
NOTE:
LEDE-Project uses a patched version of ~igmpproxy~[fn:1], which can be viewed [[https://github.com/lede-project/source/tree/v17.01.4/package/network/services/igmpproxy/patches][here]]. As of LEDE 17.01.04, the version number is ~igmpproxy-0.1-9~.
The ~list altnet ...~ is described in ~doc/igmpproxy.conf.5.in~:
#+BEGIN_QUOTE
Defines alternate sources for multicasting and IGMP data. The network
address must be on the following format 'a.b.c.d/n'. By default the
router will accept data from sources on the same network as configured
on an interface. If the multicast source lies on a remote network, one
must define from where traffic should be accepted.

This is especially useful for the upstream interface, since the source
for multicast traffic is often from a remote location. Any number of
altnet parameters can be specified.
#+END_QUOTE

The detail call graph[fn:2]:
#+BEGIN_SRC C
  igmpproxy.c:

  /**
  ,*   Main daemon loop.
  ,*/
  void igmpProxyRun() {
    ...
    acceptIgmp(recvlen);
    ...
  }

  igmp.c:

  /**
   ,* Process a newly received IGMP packet that is sitting in the input
   ,* packet buffer.
   ,*/
  void acceptIgmp(int recvlen) {
    ...
    else if(!isAdressValidForIf(checkVIF, src)) {
      struct IfDesc *downVIF = getIfByAddress(src);
      if (downVIF && downVIF->state & IF_STATE_DOWNSTREAM) {
	my_log(LOG_NOTICE, 0, "The source address %s for group %s is from downstream VIF. Ignoring.",
	       inetFmt(src, s1), inetFmt(dst, s2));
      } else {
	my_log(LOG_WARNING, 0, "The source address %s for group %s, is not in any valid net for upstream VIF.",
                          inetFmt(src, s1), inetFmt(dst, s2));
      }
      return;
    }
            
    // Activate the route.
    my_log(LOG_DEBUG, 0, "Route activate request from %s to %s",
	   inetFmt(src,s1), inetFmt(dst,s2));
    activateRoute(dst, src);
    ...
  }

  ifvc.c:

  /**
  ,*   Function that checks if a given ipaddress is a valid
  ,*   address for the supplied VIF.
  ,*/
  int isAdressValidForIf( struct IfDesc* intrface, uint32_t ipaddr ) {
      struct SubnetList   *currsubnet;
    
      if(intrface == NULL) {
          return 0;
      }
      // Loop through all registered allowed nets of the VIF...
      for(currsubnet = intrface->allowednets; currsubnet != NULL; currsubnet = currsubnet->next) {
          // Check if the ip falls in under the subnet....
          if((ipaddr & currsubnet->subnet_mask) == currsubnet->subnet_addr) {
              return 1;
          }
      }
      return 0;
  }
#+END_SRC
IGMPProxy uses _Linux Kernel Multicast Routing API_ to (de)activate the route. Consult [[https://www.tldp.org/HOWTO/Multicast-HOWTO.html][here]] for further details.

**** wndr3700v2 in PPPoE mode
r200o: 
~1_INTERNET_B_VID_3961~ in *BRIDGE* mode.
~3_IPTV_R_VID_3964~ in *DHCP* mode.
#+BEGIN_EXAMPLE
  # LEDE:
  ## Preparation:

  System -> Software
	 install tcpdump
  ### Use tcpdump to analyze packet's infomation
  $ tcpdump -i eth1 -n -e -v‚Ü≤
  $ tcpdump -i eth1.3964 -n -v igmp‚Ü≤
  07:51:57.855651 xx:xx:xx:xx:xx:xx > 01:00:5e:00:00:01, ethertype IPv4 (0x0800), length 60: (tos 0xc0, ttl 1, id 0, offset 0, flags [none], proto IGMP (2), length 32, options (RA))
      192.168.1.100 > 224.0.0.1: igmp query v2  ‚ù∂

  [Keep WAN/WAN6 temporarily for failsafe purpose!]
  Network -> Interfaces -> Interface Overview
	  -> WAN -> Edit
		 -> Protocal: Unmanaged
	  -> WAN6 -> Edit
	   	  -> Protocal: Unmanaged
  ----------------------------------------------------
  Network -> Interfaces -> Add new interfaces...
	  Create Interface
	    Name of the new interface: internet
	    Protocal of the new interface: PPPoE
	    Cover the following interface: ‚äôCustom Interface: eth1.3961
	  	    	      		 	    	       Submit‚Ü≤

          [Jump to page]:					     
          Interfaces - INTERNET
	  -> Common Configuration
	     -> General Setup
		PAP/CHAP username: xxx
		PAP/CHAP password: xxx
	     -> Physical Settings
		‚äô Software VLAN: "eth1.3961"(internet)
	     -> Firewall Settings
		‚äô internet:
		Save & Apply‚Ü≤

	  Create Interface
	    Name of the new interface: iptv
	    Protocal of the new interface: Static address
	    Cover the following interface: ‚äôCustom Interface: eth1.3964
	  	    	      		 	  	       Submit‚Ü≤
	  [Jump to page]:
	  Interfaces - IPTV
	  -> Common Configuration
	     -> General Setup
		IPv4 address: 192.168.100.252
		IPv4 netmask: 255.255.255.0
		IPv4 gateway: ‚ù∑
	     -> Physical Settings
		‚äô Software VLAN: "eth1.3964"(iptv)
	     -> Firewall Setttings
		‚äô unspecified -or- create: iptv ‚ù∏
		Save & Apply‚Ü≤

  Network -> Firewall -> Firewall - Zone Setttings
	  -> Zones
	     -> iptv: ... Edit‚Ü≤
		-> Zone "iptv"
	      	   -> General Settings
		      Input: reject
		      Masquerading: ‚òë
		      Covered networks: ‚òë iptv:
		   -> Inter-Zone Forwarding
		      Allow Forward from source zones: ‚òë lan: lan:
		      Save & Apply‚Ü≤
#+END_EXAMPLE
‚ù∂
Help to verify that IGMPProxy receives IGMP Query message from
upstream and manages multicast route to downstream correctly.

~01:00:5e:00:00:01~ is a multicast mac address that can be mapped to
the multicast ip address ~224.0.0.1~[fn:3], which is "The All Hosts
multicast group addresses all hosts on the same network segment".[fn:4]

‚ù∑
According to [[https://lede-project.org/docs/user-guide/routes_configuration][IPv4 Routes]], empty ~gateway~ field means:
#+BEGIN_QUOTE
interface:
Specifies the logical interface name of the parent (or master)
interface this route belongs to; must refer to one of the defined
interface sections.

gateway:
If omitted, the gateway from the parent interface is taken; if set to
0.0.0.0 no gateway will be specified for the route
#+END_QUOTE
Only one gateway of ~eth1.3961~ and ~eth1.3964~ can exist[fn:5]. 

‚ù∏
If there is no zone called 'iptv' exists, Lede's firewall will complain:
#+BEGIN_EXAMPLE
  /etc/init.d/firewall restart‚Ü≤
  ...
  Warning: Warning: ubus rule (ubus:igmpproxy[instance1] rule 0) refers to not existing zone 'iptv'
  Warning: Warning: ubus rule (ubus:igmpproxy[instance1] rule 1) refers to not existing zone 'iptv'
  ...
#+END_EXAMPLE
And the required firewall rules, which enables multicast udp traffics
to pass through, will NOT be created automatically.
#+BEGIN_SRC sh
  /etc/init.d/igmpproxy:

  igmp_add_firewall_routing() {
	  config_get network $1 network
	  config_get direction $1 direction

	  [[ "$direction" = "downstream" ]] || return 0

	  json_add_object ""
	  json_add_string type rule
	  json_add_string src "$upstream"
	  json_add_string dest "$network"
	  json_add_string family ipv4
	  json_add_string proto udp
	  json_add_string dest_ip "224.0.0.0/4"
	  json_add_string target ACCEPT
	  json_close_object
  }
#+END_SRC

#+NAME: igmp
~/etc/config/igmpproxy~:
#+BEGIN_EXAMPLE
  config igmpproxy
	  option quickleave 1
  #	option verbose [0-2]

  config phyint iptv 
	  option network iptv
	  option direction upstream
	  list altnet 192.168.1.0/24
	  list altnet 202.106.212.0/24

  config phyint lan
	  option network lan
	  option direction downstream
#+END_EXAMPLE

**** using static route
#+BEGIN_EXAMPLE
  LEDE 17.01.04

  Network -> Static Routes -> Static IPv4 Routes -> Add

  # As shown in the following table.
#+END_EXAMPLE
| Interface |        Target |  IPv4 Netmask |   IPv4 Gateway | Metric | MTU | Route type | My Note         |
| iptv      | 202.106.212.0 | 255.255.254.0 | 192.168.100.1‚ù∂ |        |     | unicast    | 90%Ê≠£Âú®ÁôªÂΩïÁ≥ªÁªü |
| iptv      |    210.13.0.0 | 255.255.224.0 |  192.168.100.1 |        |     | unicast    |                 |
| iptv      |   61.135.88.0 | 255.255.254.0 |  192.168.100.1 |        |     | unicast    |                 |
| iptv      |    61.149.3.0 | 255.255.255.0 |  192.168.100.1 |        |     | unicast    | ‚ù∑               |

‚ù∂ 
Setting gateway here, not when creating the IPTV interface, is to
avoid conflicting with the gateway of PPPoE interface[fn:5].

‚ù∑
‰∏ªÁïåÈù¢ÔºåÁÇπÂáª"IPTV"ÂêéÔºåÊòæÁ§∫Ôºö
#+BEGIN_EXAMPLE
    Â±èÂπï‰∏äÊñπÊ≠£‰∏≠ÔºåÊé•ËøûÊòæÁ§∫Ôºö

    ‰∏ö:00000;Ê≠£Âú®Ëé∑ÂèñÈ¢ëÈÅìÂàóË°®ËØ∑Á®çÂÄô...
    ‰∏ö-00000;Ê≠£Âú®Ëé∑Âèñ‰∏öÂä°ÂÖ•Âè£ËØ∑Á®çÂÄô...
    ‰∏ö:00000;Ê≠£Âú®ËøõË°åepgËøûÊé•ËØ∑Á®çÂÄô...

    ÁÑ∂ÂêéÔºåÂ±èÂπïÂ∑¶‰∏ãÔºö
    Ê≠£Âú®ËøõÂÖ•ÔºåËØ∑Á®çÂÄô
#+END_EXAMPLE

* Appendix III. R7800 source code
Source code package can be obtained from [[https://kb.netgear.com/2649/NETGEAR-Open-Source-Code-for-Programmers-GPL][Netgear Open Source Code for Programmers(GPL)]].
Naming conventions in related scripts:
#+BEGIN_EXAMPLE
  .../package/base-files/files/lib/cfgmgr/enet.sh:

  # this file is target depedent, it provids
  # 1. following variables :
  #      RawEth=         # name of raw eth NIF. not assigned means 2 eth NIFs, otherwise 1 eth NIF.
  #      RawEthLan=      # name of raw eth NIF for lan.
  #      RawEthWan=      # name of raw eth NIF for wan.
  #      WanIndepPhy=    # 0 means RawEthWan doesn't have independent phy (ie. connects to switch).
  #                      # 1 means RawEthWan has independent phy (ie. doesn't connects to switch).
  # 2. following functions :
  #      et_init()       # initialize ethernet & switch.
  #      sw_configvlan() # configure switch vlan for all kind of opmode.
  #

  RawEth=
  RawEthLan=eth1
  RawEthWan=eth0
  WanIndepPhy=0
  ...

  # for ap148-r7500 (8327 switch) : 
  #    sw port0 -> CPU (RawEthWan)
  #    sw port6 -> CPU (RawEthLan) 
  #    sw port1 -> LAN4 
  #    sw port2 -> LAN3 
  #    sw port3 -> LAN2 
  #    sw port4 -> LAN1 
  #    sw port5 -> WAN 

  .../package/base-files/files/lib/cfgmgr/opmode.sh:

  # name of NIF :
  #   Eth Lan NIF will always be "ethlan"
  #   Eth Wan NIF will always be "ethwan"
  #   Lan NIF will always be "br0"
  #   Wan NIF will be "brwan" or "ppp0"

  .../package/base-files/files/etc/rc.common:

  LAN_IF=ethlan
  BR_IF=br0
  WAN_IF=brwan
#+END_EXAMPLE
VLAN settings:
~#swconfig dev switch0 show‚Ü≤~
| Port | 0 | 1 | 2 | 3 | 4 | 5 | 6 |
| PVID | 0 | 1 | 3 | 3 | 3 | 0 | 3 |

#+BEGIN_EXAMPLE
  VLAN 1:
          vid: 3964
          ports: 0t 1 5t 6t 
  VLAN 2:
          vid: 3961
          ports: 0t 5t 
  VLAN 3:
          vid: 1
          ports: 2 3 4 6
#+END_EXAMPLE
* Appendix IV. Multicast VLAN
wndr3700v2:
In PPPoE mode as described in Appendix II.
r200o:
| WANÈÖçÁΩÆ          | 1_Internet_B_VID_3961  | 3_IPTV_R_VID_3964 |
| WANÁ±ªÂûã          | Ê°•Êé•WAN                | Ë∑ØÁî±WAN           |
| ÁªëÂÆöÈ°π           | Êó†                     | LAN2              |
| ÁªÑÊí≠VLAN         | 4000                   | ÂêåÂ∑¶              |
| ÁªÑÊí≠ÈÖçÁΩÆ         | snooping(IPoEAndPPPoE) | ÂêåÂ∑¶              |
| VLANÁªëÂÆöÈÖçÁΩÆ     | 3961/3961,3964/3964    | ÂêåÂ∑¶              |
| Âá∫Âè£ÁªÑÊí≠VLANÂä®‰Ωú | ‰∏çÂÖ≥Ê≥®                 | ÂêåÂ∑¶              |

NOTE: 
igmp query, eth1.3964ÊúâÔºàeth1ÊòæÁÑ∂‰πüËÉΩÁúãËßÅÔºâÔºå eth1.3961Êó†„ÄÇ
ÁîµËÑëÊí≠Êîærtp://Ôºå udpÁªÑÊí≠ÊµÅ‰ªéeth1.3964ËøõÂÖ•Ë∑ØÁî±Ôºå eth1.3961Êó†„ÄÇ

1_Internet_B_VID_3961Ôºå ÁªÑÊí≠VLANÂ°´‰∏çÂ°´ÁªìÊûú‰∏ÄÊ†∑„ÄÇ
#+BEGIN_EXAMPLE
  $ tcpdump -i eth1 -e -n igmp
  ... ethertype 802.1Q (0x8100), length 64: vlan 3964, p 0, ethertype IPv4, 192.168.1.100 > 224.0.0.1: igmp query v2
#+END_EXAMPLE
3_IPTV_R_VID_3964Ôºå‰∏çÂ°´ÁªÑÊí≠VLAN(4000)ÁöÑËØù:
igmp queryÔºå eth1Êó†Ôºå eth1.3964Êó†Ôºå eth1.3961Êó†„ÄÇ
ÁîµËÑëÊí≠ÊîæÂ§±Ë¥•„ÄÇ
internet wanÂ°´4000Ôºå iptv wan‰∏çÂ°´Ôºå ÁªìÊûúÂêå‰∏ä‰∏çÂ°´iptvÈáå4000ÁöÑÊÉÖÂÜµ„ÄÇ
‰∏§ËÄÖÈÉΩ‰∏çÂ°´Ôºö
Âá∫Âè£ÁªÑÊí≠VLANÂä®‰Ωú : ÊåáÂÆö
| VLANÂÄº | igmp query | mpv |
|   4000 | ‚úñ           | ‚úñ    |
|   3964 | ‚úñ           | ‚úñ    |
|   3961 | ‚úñ           | ‚úñ    |
Ââ•Á¶ªÂíåÈÄè‰º†Ôºå ÁªìÊûú‰πüÈÉΩÂ§±Ë¥•„ÄÇ
* Appendix V. Route rules
r200o's route rules:
#+BEGIN_EXAMPLE
  SU_WAP> ip rule‚Ü≤

  0:	from all lookup local 
  0:	from all fwmark 0x202001 lookup 200 
  0:	from all fwmark 0x1f790001 lookup 200 
  0:	from all fwmark 0x1f790004 lookup 200 
  32690:	from 10.143.x.xxx lookup 101	  <- VOIP interface IP
  32690:	from 10.127.x.xxx lookup 102 	  <- IPTV interface IP
  32700:	from all fwmark 0x1f7c0001 lookup lan2 
  32700:	from all fwmark 0x1f7c0004 lookup lan2 
  32766:	from all lookup main 
  32767:	from all lookup default 

  success!
#+END_EXAMPLE
* Appendix VI. Notes
#+BEGIN_EXAMPLE
  https://tieba.baidu.com/p/5552285991
  2Ê•º, Èôàrchbk
  ÊääÈÇ£‰∏™IPTVÁöÑWANÂπ≤ÊéâÔºåÊñ∞Âª∫‰∏Ä‰∏™‰∏öÂä°Á±ªÂûãÊòØotherÔºåvlan idÊòØ3964ÔºåÁªÑÊí≠vlan
  ÊòØ3996ÁöÑwanÔºåÁªëÂÆölan4Âè£„ÄÇÂºÄÂêØÂÖâÁå´ÁöÑigmpÂäüËÉΩ„ÄÇ

  3Ê•º, Èôàrchbk
  Ê≥®ÊÑèÂ¶ÇÊûú‰∏öÂä°Á±ªÂûãÈÄâIPTVÔºåÂè™ÈÄÇÂêàË∑ØÁî±Ê®°Âºè„ÄÇÂ¶ÇÊûúÊ°•Êé•Âπ∂ÁªëÂÆöÁ´ØÂè£Ôºå‰∏öÂä°Á±ªÂûãË¶Å
  ÈÄâÊã©otherÔºåËøôÊ†∑ÁªëÂÆöÁöÑLANÂè£Ëé∑ÂæóÁöÑIPÂ∞±‰∏ç‰ºöÊòØÂÖâÁå´ÁöÑIP‰∫Ü„ÄÇ
#+END_EXAMPLE

interface.vlanid
https://wiki.openwrt.org/doc/uci/network/switch
#+BEGIN_EXAMPLE
  According to what the contributors of this section have read online,
  so far seems that the packet will be tagged by default, because they
  are associated to one physical ports that at most will have one PVID
  (port vlan id) but more than one virtual interfaces. Therefore, having
  multiple virtual interfaces, the packets must be tagged else it won't
  make sense, they won't be able to reach the interfaces or to go out.
#+END_EXAMPLE
* Footnotes

[fn:6] [[https://github.com/transmission/transmission/wiki/Why-is-my-port-closed%253F][Transmission::WIKI::Why is my port closed?]]

[fn:5] It defines the default route of ~pppoe-internet~ or ~eth1.3964~, exclusively.

[fn:4] [[https://en.wikipedia.org/wiki/Multicast_address][Multicast address]]

[fn:3] [[https://technet.microsoft.com/en-us/library/cc957928.aspx][Mapping IP Multicast to MAC-Layer Multicast]]

[fn:2] How to apply multiple patch files to source codes:
#+BEGIN_EXAMPLE
  cd .../igmpproxy-0.1‚Ü≤

  ls‚Ü≤
  ...
  configure.ac doc/ src/
  ...

  # option '-pNum':
  #   Strip  the  smallest prefix containing Num leading
  #   slashes from each file name found in the patch file.
  #   e.g.
  #   cat igmpproxy/patches/010-missing_include.patch‚Ü≤
  #
  #   --- a/src/os-linux.h
  #   +++ b/src/os-linux.h
  #   ...
  #
  #   '/src/os-linux.h' --strip Num=1 leading slash--> current directory
  patch -p1 < /path/to/patch files/*.patch‚Ü≤
#+END_EXAMPLE

[fn:1] Original source codes are on [[https://sourceforge.net/projects/igmpproxy/][Sourceforge]].

